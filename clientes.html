<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - MezWare</title>
    <meta name="theme-color" content="#1e1e1e">
    
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #4caf50;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --danger: #ff5252;
            --warning: #ffca28; /* Color para editar */
            --input-bg: #2c2c2c;
            --whatsapp: #25D366;
        }

        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
        }

        /* --- UI ELEMENTS --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background-color: #252525; border-bottom: 1px solid #333;
        }

        .btn-back {
            color: var(--text-main); text-decoration: none; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* --- CONTROLS --- */
        .controls {
            display: flex; gap: 10px; margin-bottom: 20px;
        }

        input[type="text"], input[type="tel"] {
            flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444;
            background-color: var(--input-bg); color: white; font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary); color: white; border: none;
            padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
            font-size: 1.2rem;
        }

        /* --- CLIENT LIST --- */
        .client-list { display: grid; gap: 15px; }

        .client-card {
            background-color: var(--card-bg); padding: 15px; border-radius: 10px;
            border: 1px solid #333; display: flex; justify-content: space-between;
            align-items: center; transition: transform 0.2s;
        }
        
        .client-info h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .client-info p { margin: 0; color: var(--text-muted); font-size: 0.9rem; }
        .client-tag { 
            display: inline-block; background: #333; padding: 2px 6px; 
            border-radius: 4px; font-size: 0.75rem; margin-top: 5px; color: #ddd;
        }

        .client-actions { display: flex; gap: 10px; }
        
        .btn-icon {
            background: none; border: none; cursor: pointer; font-size: 1.2rem;
            padding: 8px; border-radius: 50%; transition: background 0.2s;
            text-decoration: none; display: flex; align-items: center; justify-content: center;
        }
        .btn-call { color: var(--primary); border: 1px solid var(--primary); }
        .btn-whatsapp { color: var(--whatsapp); border: 1px solid var(--whatsapp); }
        .btn-edit { color: var(--warning); border: 1px solid var(--warning); } /* Estilo Bot√≥n Editar */
        .btn-delete { color: var(--danger); }
        
        .btn-icon:hover { background-color: rgba(255,255,255,0.05); }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: var(--card-bg); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px;
            border: 1px solid #444;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-muted); }
        .form-group input { width: 100%; box-sizing: border-box; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: transparent; border: 1px solid #555; color: #ddd; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
        .btn-save { background: var(--primary); border: none; color: white; padding: 10px 15px; border-radius: 6px; cursor: pointer; }

        #loading { text-align: center; padding: 20px; color: var(--text-muted); }

    </style>
</head>
<body>

    <div class="top-bar">
        <a href="menu.html" class="btn-back">‚Üê Volver al Men√∫</a>
        <span style="color: #666; font-size: 0.9rem;">Gesti√≥n de Clientes</span>
    </div>

    <div class="container">
        <h1>Directorio de Clientes</h1>

        <!-- Buscador y Bot√≥n Agregar -->
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Buscar por nombre o local...">
            <button class="btn-primary" onclick="openModal()" title="Agregar Nuevo">+</button>
        </div>

        <div id="loading">Cargando clientes...</div>
        <div id="clientList" class="client-list">
            <!-- Se llena con JS -->
        </div>
    </div>

    <!-- Modal Cliente (Crear / Editar) -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-top:0">Nuevo Cliente</h2>
            <form id="addClientForm">
                <!-- Campo oculto para el ID (vac√≠o = crear, con valor = editar) -->
                <input type="hidden" id="cId">
                
                <div class="form-group">
                    <label>Nombre / Raz√≥n Social</label>
                    <input type="text" id="cName" required placeholder="Ej. Fruter√≠a L√≥pez">
                </div>
                <div class="form-group">
                    <label>Tel√©fono (WhatsApp)</label>
                    <input type="tel" id="cPhone" required placeholder="Ej. 55 1234 5678">
                </div>
                <div class="form-group">
                    <label>Ubicaci√≥n / Nave</label>
                    <input type="text" id="cAddress" placeholder="Ej. Nave I, Local 45">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Configuraci√≥n
        const firebaseConfig = {
            apiKey: "AIzaSyCkqVlWv3zj3bYlz9qGQ2Y60ZTMsigCsRU",
            authDomain: "mezware-567d7.firebaseapp.com",
            projectId: "mezware-567d7",
            storageBucket: "mezware-567d7.firebasestorage.app",
            messagingSenderId: "12354459180",
            appId: "1:12354459180:web:5367e21af312b1c8426389",
            measurementId: "G-YN2R2EYFBF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Seguridad
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            else loadClients();
        });

        // 1. CARGAR CLIENTES
        let allClients = [];

        function loadClients() {
            const q = query(collection(db, "clientes"), orderBy("nombre"));
            
            onSnapshot(q, (snapshot) => {
                document.getElementById('loading').style.display = 'none';
                renderList(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
            });
        }

        function renderList(clients) {
            allClients = clients; // Actualizar cache local
            const listContainer = document.getElementById('clientList');
            listContainer.innerHTML = '';
            clients.forEach(client => listContainer.appendChild(createClientCard(client)));
        }

        // 2. CREAR TARJETA HTML
        function createClientCard(client) {
            const cleanPhone = client.telefono ? client.telefono.replace(/\D/g, '') : '';
            const waLink = `https://wa.me/52${cleanPhone}`;

            const div = document.createElement('div');
            div.className = 'client-card';
            div.innerHTML = `
                <div class="client-info">
                    <h3>${client.nombre}</h3>
                    <p>üìç ${client.ubicacion || 'Sin ubicaci√≥n'}</p>
                    <span class="client-tag">üìû ${client.telefono}</span>
                </div>
                <div class="client-actions">
                    <a href="tel:${client.telefono}" class="btn-icon btn-call" title="Llamar">üìû</a>
                    <a href="${waLink}" target="_blank" class="btn-icon btn-whatsapp" title="WhatsApp">üí¨</a>
                    <button class="btn-icon btn-edit" title="Editar">‚úèÔ∏è</button>
                    <button class="btn-icon btn-delete" title="Eliminar">üóëÔ∏è</button>
                </div>
            `;
            
            // Asignar eventos
            div.querySelector('.btn-edit').onclick = () => prepareEdit(client.id);
            div.querySelector('.btn-delete').onclick = () => confirmDelete(client.id, client.nombre);
            
            return div;
        }

        // 3. L√ìGICA DE EDICI√ìN Y CREACI√ìN (MODAL)
        
        // Funci√≥n para abrir modal en modo "Crear" (default) o "Editar"
        window.openModal = (isEdit = false) => {
            document.getElementById('clientModal').style.display = 'flex';
            if (!isEdit) {
                // Modo Crear: Limpiar todo
                document.getElementById('addClientForm').reset();
                document.getElementById('cId').value = ""; // ID vac√≠o
                document.getElementById('modalTitle').textContent = "Nuevo Cliente";
            }
        };

        // Funci√≥n llamada al hacer clic en el l√°piz
        window.prepareEdit = (id) => {
            const client = allClients.find(c => c.id === id);
            if (client) {
                document.getElementById('cId').value = client.id;
                document.getElementById('cName').value = client.nombre;
                document.getElementById('cPhone').value = client.telefono;
                document.getElementById('cAddress').value = client.ubicacion;
                
                document.getElementById('modalTitle').textContent = "Editar Cliente";
                window.openModal(true);
            }
        };

        // 4. GUARDAR (CREAR O ACTUALIZAR)
        const form = document.getElementById('addClientForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('.btn-save');
            const originalText = btn.textContent;
            btn.textContent = 'Guardando...';
            btn.disabled = true;

            const id = document.getElementById('cId').value;
            const data = {
                nombre: document.getElementById('cName').value,
                telefono: document.getElementById('cPhone').value,
                ubicacion: document.getElementById('cAddress').value
            };

            try {
                if (id) {
                    // MODO ACTUALIZAR
                    await updateDoc(doc(db, "clientes", id), data);
                } else {
                    // MODO CREAR
                    data.fechaRegistro = new Date(); // Solo al crear
                    await addDoc(collection(db, "clientes"), data);
                }
                closeModal();
            } catch (error) {
                console.error("Error:", error);
                alert("Hubo un error al guardar.");
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        // 5. ELIMINAR
        window.confirmDelete = async (id, name) => {
            if(confirm(`¬øBorrar a ${name}?`)) {
                try {
                    await deleteDoc(doc(db, "clientes", id));
                } catch (e) {
                    console.error(e);
                    alert("Error al eliminar.");
                }
            }
        };

        // 6. BUSCADOR
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allClients.filter(c => 
                c.nombre.toLowerCase().includes(term) || 
                (c.ubicacion && c.ubicacion.toLowerCase().includes(term))
            );
            
            const listContainer = document.getElementById('clientList');
            listContainer.innerHTML = '';
            filtered.forEach(client => listContainer.appendChild(createClientCard(client)));
        });

        // Utilidades Modal
        window.closeModal = () => document.getElementById('clientModal').style.display = 'none';
        window.onclick = (event) => {
            if (event.target == document.getElementById('clientModal')) closeModal();
        }
    </script>
</body>
</html>